---
layout:     post
title:      "一个关于钉钉微应用问题排查的故事"
subtitle:   ""
date:       2018-05-26 09:11:10
author:     "Paian"
catalog:    true
tags:
    - 钉钉微应用
---

### 一、背景

今天讲个故事。因为是故事，也就有来源于生活又高于生活的成分。

某年某月某天，有个小伙伴来会议室问大家：谁比较了解Vue.js，项目中有个问题跑不过去（浏览器中可以浏览页面，但在钉钉中有一块内容丢失了），需要帮看一下，看起来很焦急。会议室其他小伙伴都不是做前端的，自然并不了解，所以虽然我也知道手头的事情特别忙，而且其中有好几项紧急且重要，但是我依然认为“责无旁贷”，于是就有了下面的故事。

项目是一个嵌入钉钉中简单微应用，由两个Tab页面十个左右的组件组成。

1、前端是基于Vue.js写的，但并不是基于Vue.js提供的脚手架或者类似的其它脚手架——项目中完全没有打包、工程化这样的概念，所编写的源码就是要运行的代码。这么编写的原因可能是，外援小伙伴（因为只是个故事，姑且叫外援小伙伴吧，这并不重要，重要的是故事后面的解决问题的思路与思考）可能只是单纯地认为项目很小、尽量简单。

2、由于应用是嵌入到钉钉中的（用到了 `dd.ready`等钉钉容器的API），为了在浏览器中调试，外援小伙伴写了一个`if(!window.isInDingDing)`分支，来进行非钉钉容器的判断，并在 `dd.ready`回调函数内和`if(!window.isInDingDing)`分支中都单独写了一遍类似的逻辑（虽然其中绝大部分逻辑是一样的，但是并没有提取出两个分支中共用的部分，而是写了两遍）。

上面这两个问题带来的严重性显而易见，但是当我开始帮助解决问题的时候，我是没有认识到其中的问题的。因为我手头有更要紧的事情要做，不能恋战，只是想着用最快的速度帮助定位到这个问题，其余的不去深究。所以，开始时我对这个项目的全貌是没有完整的了解的，虽然一眼发现了没有打包和工程化的概念，但并未细想，只是认为可能设计者自有自己的考虑吧；只看到有个`BUS.$emit`，凭直觉知道是事件总线，并未去全面了解其组件之间的关系是怎么设计的；也没发现有为了浏览器调试而出现的`if(!window.isInDingDing)`分支判断，更不知道有两大块非常类似的代码。但随着问题排查的进行，所有这些都一一浮出水面。（一开始找我的时候是一个问题，而后来，问题接二连三的相继出现，直到最后搞定那些问题，才算告一段落）。

### 二、问题与思考

出现了哪些问题呢？

1、`if(!window.isInDingDing)`分支判断错误，导致钉钉容器中渲染异常。

外援小伙伴对钉钉容器的判断采用的是这样的方式：在`dd.ready`回调函数里设置`window.isInDingDing=true`，然后在`dd.ready`的外面，紧接着`dd.ready`写了一个`if(!window.isInDingDing)`分支判断。

因为`dd.ready`回调是异步执行的，所以当注册了`dd.ready`回调之后，继续往下执行的时候`window.isInDingDing`其实依然是undefined。所以`if(!window.isInDingDing)`分支虽然本来是写给浏览器调试用的，却因判断错误在钉钉容器中也走了一遍，这就是导致一开始的那个“浏览器中可以浏览页面，但在钉钉中有一块内容丢失了”问题的原因。

思考：

这种判断方式实在是不靠谱，也没有理解`dd.ready`回调的执行时机，判断容器的正确姿势不应该是通过UA或者SDK有没有挂载出来某个全局变量之类的来判定吗？常识的欠缺，有时候往往是灾难啊！

2、明明看起来是修改了代码，在浏览器中预览也没问题，但是在钉钉容器中就是没有变化。

因为存在`dd.ready`回调和`if(!window.isInDingDing)`两个分支，且两个分支代码相似，所以很容易出现修改的时候只改了一个分支而未同步修改另一个分支的情况，这就是导致“明明看起来是修改了代码，在浏览器中预览也没问题，但是在钉钉容器中就是没有变化”的原因。

思考：

应该果断地把两个分支中共用的部分提取出来进行共用，这样才能避免后面再出现掉入同一坑里的现象。

3、由于采用的不是常用的脚手架方式构建的Vue项目，无文档，无注释，所有的JS代码都堆积在两个JS文件中，完全没有模块化的划分，其他小伙伴无法理解其组件之间的通信设计。

解决完上述两个问题后，我因为有紧急事情需要处理，所以这个项目的负责人又去找其它部门的小伙伴给解决一些其它问题，但是被找到的小伙伴搞不懂组件之间数据是如何传递的，所以后来又只好找到我去帮助解决。当时我也没有完整地看代码，并不清楚其整体上是如何设计通信的，但是我看到了其它组件之间也有类似的通信方式，于是照猫画虎，问题很快得到解决。

思考：

（1）一个项目的架构，不管项目是大是小，除非有非常充分的理由，否则还是尽量采用比较为大众所熟知架构，不要搞得特别个性化，因为个性化就意味着有一天如果有人要接手你的这个项目的话，所有个性化的东西都是成本。

（2）清晰的代码结构和模块划分，在项目可维护性上显得非常重要，大坨的代码堆积在一个文件中，会显著降低问题排查和定位的效率。

（3）另一方面，有一定工作经验的时候，必须得形成一定思路，在看个性化的代码的时候，能有办法理解其设计，应急的情况可以从照猫画虎开始，时间充足的情况可以先大体看目录结构的划分及其大致含义，然后从入口开始，逐一深入各个分支、方法、模块等，跟清楚一条条代码执行的路径。沉淀出自己的经验和方法论，避免遇到别人写的项目不知从何处下手、面对问题没有思路而只能抓瞎的情况，是工程师成长的必经之路。

4、终于，主体功能在iOS中都可用了，但是在Android中却未能展示出来，页面主体区域为空白。

在Android手机中，我尝试了先在Chrome等一些浏览器中打开，没有问题，然后再换UC浏览器打开，有问题，所以我就想，要不下载一个UC浏览器的开发者版来来调试一下吧，结果UC浏览器的开发者版中再访问，居然没有问题，所以这条线索就段了。无奈，只好将我的钉钉卸载掉，换装钉钉的开发者版来调试。具体的操作如下：

首先，要在钉钉开发者版本中启动微应用调试。启用步骤如下：

- 进入“我的”(个人资料页)

- 选择“设置”

- 选择“通用”

- 选择“开发者选项”

- 打开“微应用调试”

其次，用数据线连接安卓手机。

第三，在安卓手机的开发者选项中开启手机的USB调试。

第四，在Chrome浏览器中输入chrome://inspect/#devices，找到要调试的页面，点击“inspect”。

第五，连接上科学上网，这样才能打开调试的窗口，否则弹出的窗口可能是空白或者显示404之类。

然后，我就在调试窗口的console中看到了报错信息，原来是JS中用到了一些函数简写和模版字符串之类ES6语法，因为项目完全没有打包概念、自然也就没有Babel转换环节，所以ES6语法是不能用的。逐一将ES6新语法改掉，问题解决。最后，再让他们自己去加个Babel转换处理，避免不断被坑。

思考：

这其实就是没做工程化的代价！除此之外，CSS的浏览器前缀也只能手动去加了。这是个大坑，折射出起一个项目时，这个人的经验与思考是多么重要！前面起项目架子的人没有足够的考虑，后面的人只有两个选择，要么在他埋下的坑里不断小修小补，不断填坑，要么推倒重来。

### 三、后记

忙到很晚终于搞定了这些问题之后，在回家的路上，我闭上眼睛放电影一样过这个故事。

因为这个项目并不是一个正儿八经排入需求的项目，所以开发资源上是没有固定支持的，项目负责人只能以找人“帮忙”的形式去开展。这在小伙伴工作饱和度不是很高、也有人感兴趣的情境下，是可行的。但是当这种情境不成立时，推动起来就会比较困难。所以，情境不满足的情况下，要么自己可以搞定或者可以忍受不断找人的局面，要么需要立项以获得资源支持，要么就自己能够承受相应的问题。

我也听项目负责人提起过找人帮忙过程中被拒的遭遇。我一开始有点心疼这个项目负责人，但慢慢地又并不心疼起来，因为我知道他跟我一样，都是自己做的选择，他选择了负责这个项目，就选择了不断找人帮忙甚至碰壁，我选择了在自身精力和时间腾挪空间很小的情况下给到他一些支持，选择的背后一定意味着牺牲。问题最终得到解决，这是选择的结果。

关于找人帮忙，可能有人愿意尽力而为，也可能有人因为这是份外之事，而不愿支持的。确实，从最基本考虑上来说，既然是找人帮忙，别人也可以选择不帮，而且确实也有人经历上可能完全没有腾挪的空间，这无可厚非。但是，从个人格局和担当上来说，如果找你帮忙的是对于整个团队有意义的事情或者正向的事情，你其实值得考虑是不是在可行的范围内尽可能给一些支持，哪怕是牺牲一些私人时间。我想人与人之间差别并没有那么大，很多时候，差别也许就体现在看起来进退均可的情况下，不同的人所做的不同选择。

恭喜你和我一道又进了一步，加油！
